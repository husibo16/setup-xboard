#!/bin/bash
# ------------------------------------------------------------------
# Xboard + MariaDB ä¸€é”®æ™ºèƒ½å®‰å…¨é‡å¯è„šæœ¬ï¼ˆv3.1 ç¨³å®šç‰ˆï¼‰
# ä½œè€…: èƒ¡åšæ¶µ
# ç‰¹æ€§: å¹¶å‘é” + æ™ºèƒ½å®¹å™¨è¯†åˆ« + ä¼˜å…ˆçº§ + å¥åº·æ£€æµ‹ + è‡ªåŠ¨æ¸…ç†
# ------------------------------------------------------------------

set -euo pipefail

LOCK_FILE="/tmp/xboard-restart.lock"
LOG_FILE="/var/log/xboard-restart.log"
PROJECT="${PROJECT:-xboard}"
XBOARD_IMAGE_PREFIX="${XBOARD_IMAGE_PREFIX:-ghcr.io/cedar2025/xboard}"
REDIS_IMAGE="${REDIS_IMAGE:-redis:7-alpine}"

# === ğŸ”’ å¹¶å‘é”ï¼ˆè‡ªåŠ¨é‡Šæ”¾ + è¶…æ—¶æ¸…ç†ï¼‰===
if [ -f "$LOCK_FILE" ] && find "$LOCK_FILE" -mmin +5 >/dev/null 2>&1; then
  echo "[$(date '+%F %T')] [WARN] å‘ç°è¿‡æœŸé”æ–‡ä»¶ï¼Œè‡ªåŠ¨æ¸…ç†ã€‚" | tee -a "$LOG_FILE"
  rm -f "$LOCK_FILE"
fi

exec 200>"$LOCK_FILE"
if ! flock -n 200; then
  echo "[$(date '+%F %T')] âš ï¸ å·²æœ‰ä¸€ä¸ªé‡å¯ä»»åŠ¡åœ¨è¿è¡Œï¼Œé€€å‡ºã€‚" | tee -a "$LOG_FILE"
  exit 0
fi

cleanup_lock() {
  flock -u 200 || true
  rm -f "$LOCK_FILE"
}
trap cleanup_lock EXIT INT TERM

# === ğŸ“œ æ—¥å¿—å‡½æ•° ===
log() { echo "[$(date '+%F %T')] $*" | tee -a "$LOG_FILE"; }

# === æ—¥å¿—å½’æ¡£ï¼ˆ>20MB è‡ªåŠ¨å¤‡ä»½ï¼‰===
if [ -f "$LOG_FILE" ] && [ "$(du -m "$LOG_FILE" | cut -f1)" -gt 20 ]; then
  mv "$LOG_FILE" "${LOG_FILE}.$(date +%F-%H%M%S).bak"
fi

log "=== ğŸš€ å¼€å§‹æ‰§è¡Œ Xboard + MariaDB ä¸€é”®é‡å¯ ==="

# === 1ï¸âƒ£ æ£€æŸ¥ Docker æœåŠ¡çŠ¶æ€ ===
if ! systemctl is-active --quiet docker; then
  log "[WARN] Docker æœªè¿è¡Œï¼Œå°è¯•å¯åŠ¨..."
  systemctl start docker
  sleep 3
fi
if ! docker info >/dev/null 2>&1; then
  log "[WARN] Docker å®ˆæŠ¤è¿›ç¨‹æœªå“åº”ï¼Œå°è¯•é‡å¯..."
  systemctl restart docker
  sleep 5
fi

# === 2ï¸âƒ£ æ™ºèƒ½å‘ç°å®¹å™¨ ===
discover_containers() {
  local list=""
  local lbl="com.docker.compose.project=${PROJECT}"

  # åŸºäº docker-compose label
  if docker ps --filter "label=${lbl}" --format '{{.Names}}' | grep -q .; then
    list="$(docker ps --filter "label=${lbl}" --format '{{.Names}}')"
  fi

  # é•œåƒåŒ¹é…å…œåº•
  local by_image="$(docker ps --filter "ancestor=${XBOARD_IMAGE_PREFIX}" --format '{{.Names}}')"
  local by_redis="$(docker ps --filter "ancestor=${REDIS_IMAGE}" --format '{{.Names}}')"

  printf "%s\n%s\n%s\n" "$list" "$by_image" "$by_redis" | awk 'NF{seen[$0]++}END{for(k in seen)print k}' | sort
}

# === 3ï¸âƒ£ æ™ºèƒ½ä¼˜å…ˆçº§æ’åºï¼ˆæ”¯æŒ web/frontend/php/horizon/redis ç­‰ï¼‰===
prioritize_containers() {
  awk '
    /web|frontend|nginx/   {print "1\t"$0; next}
    /php|fpm/              {print "2\t"$0; next}
    /horizon|queue|worker/ {print "3\t"$0; next}
    /redis/                {print "9\t"$0; next}
    {print "5\t"$0}
  ' | sort -k1,1n | cut -f2-
}

log "ğŸ” æ™ºèƒ½æ£€æµ‹å®¹å™¨ä¸­..."
mapfile -t CONTAINERS < <(discover_containers | prioritize_containers)

if [ ${#CONTAINERS[@]} -eq 0 ]; then
  log "âš ï¸ æœªå‘ç°åŒ¹é…å®¹å™¨ï¼ˆPROJECT=$PROJECT, IMAGE_PREFIX=$XBOARD_IMAGE_PREFIXï¼‰"
else
  log "å‘ç°å®¹å™¨ï¼š${CONTAINERS[*]}"
  # === 4ï¸âƒ£ é‡å¯å®¹å™¨ ===
  for container in "${CONTAINERS[@]}"; do
    if docker ps --format '{{.Names}}' | grep -qx "$container"; then
      log "â†’ æ­£åœ¨é‡å¯ $container ..."
      docker restart "$container" >/dev/null 2>&1 \
        && log "âœ… $container é‡å¯å®Œæˆ" \
        || log "âŒ $container é‡å¯å¤±è´¥"
    else
      log "â†’ å®¹å™¨ $container æœªè¿è¡Œï¼Œå°è¯•å¯åŠ¨..."
      docker start "$container" >/dev/null 2>&1 \
        && log "âœ… $container å¯åŠ¨å®Œæˆ" \
        || log "âŒ $container å¯åŠ¨å¤±è´¥"
    fi
  done
fi

# === 5ï¸âƒ£ æ£€æŸ¥å¼‚å¸¸å®¹å™¨ ===
bad=$(docker ps --filter "health=unhealthy" --filter "status=dead" --format '{{.Names}}')
if [ -n "$bad" ]; then
  log "âš ï¸ ä»¥ä¸‹å®¹å™¨å¤„äºå¼‚å¸¸çŠ¶æ€ï¼š$bad"
fi

# === 6ï¸âƒ£ é‡å¯æ•°æ®åº“æœåŠ¡ï¼ˆmariadb / mysqlï¼‰===
for svc in mariadb mysql; do
  if systemctl list-unit-files | grep -q "^$svc.service"; then
    log "ğŸ”„ æ£€æµ‹åˆ°æ•°æ®åº“æœåŠ¡ $svcï¼Œæ­£åœ¨é‡å¯..."
    systemctl restart "$svc" && log "âœ… $svc é‡å¯å®Œæˆ" || log "âŒ $svc é‡å¯å¤±è´¥"
    break
  fi
done

# === 7ï¸âƒ£ æ¸…ç† Docker èµ„æº ===
log "ğŸ§¹ æ¸…ç†æ— ç”¨ Docker èµ„æº..."
docker system prune -f >/dev/null 2>&1

# === 8ï¸âƒ£ è¾“å‡ºå®¹å™¨çŠ¶æ€ ===
log "ğŸ“¦ å½“å‰è¿è¡Œä¸­çš„å®¹å™¨ï¼š"
docker ps --format "table {{.Names}}\t{{.Status}}" | tee -a "$LOG_FILE"

log "âœ… å…¨éƒ¨é‡å¯å®Œæˆã€‚æ—¥å¿—å·²ä¿å­˜è‡³ï¼š$LOG_FILE"
exit 0
